{%load static %}
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Exercise</title>
	<link rel="stylesheet" href="{% static 'css/main.css'%}">
	<link rel="icon" type="image/png" href="{% static 'icons/dumbell.svg'%}">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
      <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
     

</head>
<style>
    * {
      box-sizing: border-box;
      font-family: 'Lato', sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      background-color: #fcfafa;
      color: #333;
    }

    aside img {
      width: 100%;
    }
    main {
      flex-grow: 1;
      padding: 2rem;
    }
    .mode-switch {
      margin-bottom: 1rem;
    }
    .mode-switch button {
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      margin-right: 1rem;
      border-radius: 10px;
      background-color: #eee;
      opacity: 0.55;
    }
    .mode-switch button.active {
      background-color: #4CAF50;
      color: #fff;
      opacity: 1;
    }
    .weekly-activity {
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 2rem;
    }
    .card {
      background-color: #fff;
      padding: 1rem;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
   width: 100%;
    }
    .card.full-width {
      grid-column: 1 / -1;
    }
    h2 {
      margin-bottom: 1rem;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    .twoCards
    {
        display: flex;
    }
  </style>
<body>
  <div id="app">
<aside>
    
        <nav class="navigation">
            
            <div class="upperPart">
            <div class="icon"></div>
            <a href="#" class="btn doublehelix" ><img src="{% static 'icons/doublehelix.svg'%}" alt="Doublehelix" ></a>
            <a href="{% url 'dashboard:home' %}" class="btn main"><img src="{% static 'icons/main.svg'%}" alt="Main"></a>
            <a href="{% url 'nutrition:nutrition'%}" class="btn nutrition"><img src="{% static 'icons/Nutrition.svg'%}" alt="nutrition" ></a>
            <a href="{% url 'exercise:exercise' %}" class="btn exercise"><img src="{% static 'icons/dumbell.svg'%}" alt="Exercise" ></a>
            <a href="" class="btn settings"><img src="{% static 'icons/Settings.svg'%}" alt="Settings" ></a>
            <a href="" class="btn calendar"><img src="{% static 'icons/Calendar.svg'%}" alt="Calendar" ></a>
            <a href="" class="btn progressChart"><img src="{% static 'icons/Statistics.svg'%}" alt="progressChart" ></a>
            </div>
        <div class="lowerPart">
            <a href="" class="btn"><img src="{% static 'icons/Help.svg'%}" alt="Help" ></a>
            <a href="{% url 'accounts:logout' %}" class="btn"><img src="{% static 'icons/Exit.svg'%}" alt="Exit" ></a>
            <a href=""></a> 
        </div>
        </nav>
    
</aside>
<main>
	<div class="header">
			<h2>Exercise</h2>
            <div class="tools">
                <div class="search">
                    <img src = "{% static 'icons/search.svg'%}" alt="search">
                </div>
                  <div class="notification">
                    <img src = "{% static 'icons/notification.svg'%}">
                </div>
            </div>
            <div class="optionalTools">
            	<div class="avatar">
            		<img src="{% static 'icons/avatar.svg'%}" alt="avatar">
            	</div>
            	<div class="filter">
            		<img src="{% static 'icons/filter.svg'%}" alt="filter">
            	</div>
            </div>
		</div>
     <main>
      <div id="calendar"></div>
    <div class="mode-switch">
      <button  data-mode="gym">Gym</button>
      <button data-mode="home">Home</button>
    </div>
    <div class="weekly-activity">
      <h2>Weekly Activity</h2>
      <div class="dashboard">
         <div class="card">
          <h3>Logged Exercises</h3>
          <ul id="exerciseList"></ul>
        </div>
        <div class="card">
          <h3>Workouts Per Week</h3>
          <canvas id="workoutChart"></canvas>
        </div>
    <div class="twoCards">
        <div class="card">
          <ul id="mostFrequentExercises" >Most frequent exercises</h3>
          <ol>
          <li v-for="exercise in top3" :key="exercise.name">{{exercise.name}}-{{exercise.value}}
</li>
          <!--   <li>Push-up squats - 5</li>
            <li>Squats - 6</li>
            <li>Plank - 4</li>
           -->
         </ol>


        </div>
        <div class="card">
          <h3>Streak tracker</h3>
          <p v-if="streak!=0">
            Youâ€™re on a {{streak}} day streak
          <p v-else>No Streaks</p>
</p>
        </div>
    </div>
        <div class="card full-width">
          <h3>Customer Map</h3>
          <p><strong>450 kcal left</strong><br/>Calorie Goal: 2,000 kcal</p>
          <canvas id="calorieChart"></canvas>

        </div>
        <div class="card full-width">
          <canvas id ="exerciseDoughnut"style="width:100%;max-width:600px"></canvas>

        </div>
      </div>
    </div>

  </main>
</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
const {createApp} = Vue;
const app = createApp({

data()
{
  return {
    top3 : [],
    counts : [],
    streak: 0,
    workouts:[],
     exercises: []
}
  ;
},
async mounted(){
const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
let caloriesIn = new Array(7).fill(0)
let caloriesOut = new Array(7).fill(0)
fetch("http://127.0.0.1:8000/app/getWorkouts", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (!data.success) return;

        this.workouts = data.workouts;

        // build top 3
        this.counts = {};
        data.workouts.forEach(w => {
          this.counts[w.name] = (this.counts[w.name] || 0) + 1;
        });

        this.top3 = Object.entries(this.counts)
          .sort((a,b) => b[1] - a[1])
          .slice(0,3)
          .map(([name,value]) => ({name,value}));

        // default load = gym
        loadExercises("", this.workouts);
      });
  const data =  await fetch("http://127.0.0.1:8000/getCaloriesInAndOut",{credentials : "include"}).then(res=>res.json());
 data.caloriesIn.forEach(item=>
 {
  const idx = getWeekday(item.created_at)
  caloriesIn[idx] +=Number(item.calories)
 })
data.caloriesOut.forEach(item=>{
  const idx = getWeekday(item.created_at)
  caloriesOut[idx] += Number(item.calories)
})
    

      // fetch("../backend/auth/getStreakLogs.php")
      // .then(res => res.json())
      // .then(data => {
      //   this.streak = data.streak;
      //   console.log(this.streak);
      //   this.created_at = data.created_at;

      // })
      // .catch(err => {
      //   console.error("Failed to fetch streak:", err);
      // });
      const ctx2 = document.getElementById('calorieChart').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [
          {
            label: 'Consumed',
            data: caloriesIn,
            backgroundColor: 'red',
            borderRadius: 8
          },
          {
            label: 'Burned',
            data: caloriesOut,
            backgroundColor: 'gold',
            borderRadius: 8
          }
        ]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
    const labels = Object.keys(this.counts)
    const values = Object.values(this.counts)
    const barColors = [
          "#b91d47",
          "#00aba9",
          "#2b5797",
          "#e8c3b9",
          "#1e7145",
          "#4D96FF",
          "#FADADD",
          "#FFF9C4",
          "#E6E6FA",
          "#F0F8FF",
          "#FDF5E6",
          "#E0F7FA",
          "#FFFFFF",
          "#CCCCCC"
                      ];
 
    const ctx3 = document.getElementById("exerciseDoughnut");
    new Chart(ctx3,{
      type : "doughnut",
      data :{
      labels:labels,
      datasets : [
        {backgroundColor:barColors,
        data : values}
      ]
      },
     options:{
      plugins:{
        legend:{display:true},
        title: {
        display: true,
        text: "Sets of Exercices",
        font: {size:16}
      }
      }
     }
    })
}

}).mount("#app");
function getWeekday(datastr)
{
  const date = new Date(datastr);
  return (date.getDay()+ 6) % 7
}



let workoutChart = null;
    function loadExercises(selectedMode,data) {
  
      
      const sessions = [0, 0, 0, 0, 0, 0, 0];
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const list = document.getElementById("exerciseList");
      //for most frequent exercises tab 
      const mostFrequent = document.getElementById("mostFrequentExercises"); 
      let counts=[];
      // Get Monday and Sunday of the current week
      const now = new Date();
      console.log(now + " ");
      const day = now.getDay();
      const monday = new Date(now);
      console.log(monday);
      monday.setDate(now.getDate() + (day === 0 ? -6 : 1 - day));
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);

      list.innerHTML = data.filter(entry => entry.mode === selectedMode)
        .filter(entry => {
          const [year, month, day] = entry.created_at.split("-");
          const date = new Date(year, month - 1, day, 12);
          return date >= monday && date <= sunday;
        })
        .map(entry => {
          const [year, month, day] = entry.created_at.split("-");
          const date = new Date(year, month - 1, day, 12);
          const jsDay = date.getDay();
          const index = (jsDay + 6) % 7;
          sessions[index] += 1;
        const tz = "Asia/Tashkent";
        const created_atDate = new Date(new Date(entry.created_at).toLocaleString('en-US',{timeZone:tz}));
        const weekday = new Intl.DateTimeFormat('en-US',{
          timeZone : tz,
          weekday :'short'
        }).format(created_atDate);
         console.log(weekday);
          return `<li>${entry.name} - ${entry.sets} sets, ${entry.reps} reps @ ${entry.weight} + <b>${weekday}</b></li> `;
        })
        .join("");
      
      const ctx1 = document.getElementById('workoutChart').getContext('2d');
      if (workoutChart) {
  workoutChart.destroy();
  
}
      workoutChart = new Chart(ctx1, {
  type: 'bar',
  data: {
    labels: days,
    datasets: [{
      label: `${selectedMode === 'gym' ? 'Gym' : 'Home'} Workouts`,
      data: sessions,
      backgroundColor: '#3366FF',
      borderRadius: 8
    }]
  },
  options: {
    scales: { y: { beginAtZero: true } }
  }
});
    
}
    
    

    document.querySelectorAll(".mode-switch button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".mode-switch button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const selectedMode = btn.getAttribute("data-mode");
    loadExercises(selectedMode,app.workouts);
  });
});
    
  </script>
</body>
</html>

</body>
</html>