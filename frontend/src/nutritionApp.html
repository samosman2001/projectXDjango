<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log New Meal</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Chart.js for chart -->
  <script src ="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <link rel="stylesheet" type="text/css" href="styles/mainApp.css">
  <link rel="stylesheet" type="text/css" href="styles/exerciseApp.css">
   <link rel="stylesheet" type="text/css" href="styles/mainApp.css">
  <link rel="stylesheet" type="text/css" href="styles/login.css">
  <style>
body {
  margin: 0; /* remove default spacing */
  padding: 0;
  width: 100vw;
  height: 100vh;
}
    header img {
      height: 40px;
    }
    .meal-type {
      display: flex;
      padding: 10% 5% 5% 5%;
      gap: 1rem;
      margin: 1rem 0;
      justify-content: center;
    }
    @media (max-width: 660px)
    {
       .meal-type {
      padding-top: 20%;
    }
    }
    .meal-type button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 20px;
      background-color: #e0e0e0;
      cursor: pointer;
    }
    .meal-type .active {
      background-color: #007BFF;
      color: white;
    }
    .meal-form {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .meal-form input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .tags span {
      padding: 0.3rem 0.7rem;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 12px;
    }
    .add-btn {
      background-color: green;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    .summary, .chart {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-weight: 10;
    }
.chart
{
  display: flex;
  flex-direction: column;
}
    .summary .todaysMeal
    {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
     font-size: 20px;
          }
    .summary-row {
      display: grid;
      grid-template-columns: 0.5fr 3fr 6fr;
      justify-items: end;
      gap:1rem;    }
   .summary-row img
   {
    width: 50px;
    height: 50px;
   }
    .barCharBackground 
  {
    height: 200px; 
    width: 100%;
    background: #eee; 
    border-radius: 10px;
    text-align: center;
    line-height: 150px;
    display: flex;
    justify-content: center;
    
  }
  
 .empty
 {
  width: 100px;
  height: 100px;
 }

  </style>
</head>
<body>
  <div id="app">
    
    <header>
      <img src="assets/icons/doublehelix.svg" alt="Logo">
    </header>

    <section>
      <h3>Log New Meal</h3>
      <div class="meal-type">
        <button :class="{active: mealType==='Breakfast'}" @click="mealType='Breakfast'">Breakfast</button>
        <button :class="{active: mealType==='Lunch'}" @click="mealType='Lunch'">Lunch</button>
        <button :class="{active: mealType==='Dinner'}" @click="mealType='Dinner'">Dinner</button>
      </div>

      <p>It looks like it's {{ mealType.toLowerCase() }} time. Logging as {{ mealType }}</p>

    <!--   <div class="meal-form">
        <input v-for="(field, index) in 5" :key="index" placeholder="Food">
        <input placeholder="Meal Name">
        <div class="tags">
          <span>Calories</span><span>Protein</span><span>Carbs</span>
        </div>
        <button class="add-btn">+ Add</button>
      </div>
 -->

 <div class="meal-form">
  <input v-model="newFood" placeholder="Food Name (e.g egg,rice)"/>
  <input v-model="newGrams" placeholder="Food Gram"/>
    <button class="add-btn" @click="addMeal">+ Add</button>
</div>




      <div class="summary">
        <div class="todaysMeal"><strong>Today's Meal</strong></div>
  <div class="summary-row" v-for="item in meals">
    <div ><img :src="`../icons/${item.type.toLowerCase()}.svg`" :alt="item.type"></img></div>
    <div>
    {{ item.food }} ({{ item.type }})</div>
    <div>
      {{ item.grams.toFixed(1) }}g - {{ item.calories.toFixed(1) }} kcal<br>
      Protein: {{ item.protein.toFixed(1) }}g |
      Carbs: {{ item.carbs.toFixed(1) }}g |
      Fat: {{ item.fat.toFixed(1) }}g
    </div>
  </div>
  <hr>
  <div class="summary-row" >
    <div><img src="assets/icons/calc.webp":alt="Total"/></div>
    <div>Total</div>
    <div>
      {{ computeTotalCalories }} kcal<br>
      Protein: {{ computeTotalProtein }}g |
      Carbs: {{ computeTotalCarbs }}g |
      Fat: {{ computeTotalFat }}g
    </div>
  </div>
</div>


      <div class="chart">
        
        <h4>Calories by Day</h4>
        <!-- Replace with real chart later -->
        <div class="barCharBackground" ><canvas class="ctx">Chart Placeholder</canvas></div>
      </div>
    
<div class="empty"></div>
    </section>

<footer>
    <nav class="bottom-nav">
    <div class="item">
      <a href="nutritionApp.html">
      <div class="icon">üçé</div>
      <div>Nutrition</div>
    </a>
    </div>
    <div class="item">
      <a href="exerciseApp.html">
      <div class="icon">üèãÔ∏è</div>
      <div>Exercise</div>
     </a>
    </div>

       <div class="home-button">
 <a href="mainApp.html">
    üè†
  </a></div>

    <div class="item">
      <div class="icon">üóìÔ∏è</div>
      <div>Calendar</div>
    </div>
    <div class="item">
      <div class="icon">üìà</div>
      <div>Progress</div>
    </div>
  </nav>
  </div>

</footer>
</div>
<div class="toast success"></div>
<div class="toast fail"></div>

  <script>
   
  const { createApp } = Vue;

  // const foodDatabase = {
  //   "eggs": { calories: 100, fat: 10, carbs: 0, protein: 6 },
  //   "meat": { calories: 200, fat: 4, carbs: 0, protein: 20 },
  //   "rice": { calories: 200, fat: 1, carbs: 40, protein: 1 },
  //   "chicken breast": { calories: 150, fat: 5, carbs: 0, protein: 33 }
  // };

async function api (path,opts={})
{
  try{
const res = await fetch( path,
{credentials: "include",...opts});
console.log(res);
const text = await res.text(); // ‚Üê read raw output
  console.log("RAW:", text);  
  const data  =JSON.parse(text);

  //return data inside the try scope if not then return null
return data;
}
catch(err)
{
  console.log(err.message);
}
return null;
}

window.addEventListener("pageshow", async () => {
  const data = await api("http://127.0.0.1:8000/app/home/");
  console.log(data.success);
  

if (!data.success)
{
console.log("No Permission. Redirecting...");
showToast(data.error)
      setTimeout(()=>
    {
      
      window.location.href = "appLogin.html";

    },1000);
}
})

function showToast(message) {
  let toast;
  if(message.toLowerCase().includes("successfully"))
  toast = document.querySelector(".toast.success");
  else
  toast = document.querySelector(".toast.fail");
  
  toast.textContent = message;
  toast.classList.add("show");
  
  // Hide after 3s
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}
  const app = Vue.createApp({
    data() {
      return {
        mealType: "",
        newGrams: "",
        meals: JSON.parse(localStorage.getItem("meals")||"[]"),
        newFood: '',
        chart:null,
        count :0,
        foodDatabase:{}
      };
    },
    computed: {
      computeTotalProtein() {
        return this.meals.reduce((sum, meal) => sum + meal.protein, 0).toFixed(1);
      },
      computeTotalCalories() {
        return this.meals.reduce((sum, meal) => sum + meal.calories, 0).toFixed(1);
      },
      computeTotalCarbs() {
        return this.meals.reduce((sum, meal) => sum + meal.carbs, 0).toFixed(1);
      },
      computeTotalFat() {
        return this.meals.reduce((sum, meal) => sum + meal.fat, 0).toFixed(1);
      }

    },
    methods: {

      updateChart()
      { 
      
       const rawMeals = JSON.parse(JSON.stringify(this.meals)); // deep clone to avoid Vue proxy
       // const food = rawMeals.map((meal)=>meal.food);
       // const labels = rawMeals.map((meal,index)=>`${meal.type}${index + 1}`);
       let indexForLunch = 0;
let indexForBreakfast = 0;
let indexForDinner = 0;

        
   
const labels = rawMeals.map((meal) => {


   switch(meal.type)
   {
   case "Lunch":
    indexForLunch++;
    return `${meal.food}(${meal.type}${indexForLunch})`;
  case "Breakfast":
    indexForBreakfast++
    return `${meal.food}(${meal.type}${indexForBreakfast})`;
  case "Dinner":
    indexForDinner++
    return `${meal.food}(${meal.type}${indexForDinner})`;

   }
        return `No results`;


      });
       const calories = rawMeals.map(meal=>meal.calories);
       const ctx = document.querySelector(".ctx").getContext('2d');
       
        //  if(this.chart)
        // {

        //   this.chart.data.labels = labels;
        //   this.chart.data.datasets[0].data = calories;
        //   this.chart.update();
        //   // if(this.count == 0)
        //   // {this.count +=1;
        //   //  console.log(this.count);
        //   //   this.updateChart();

        //   // }
        //   }
         if (this.chart) {
    this.chart.destroy();
  }

        
          this.chart = new Chart(ctx,
        {

          type:"bar",
          data:{
        labels:labels,
        datasets:[{
     label:'Calories',
     data:calories,
     backgroundColor:'#3354F4',
     borderRadius : 10,
    barThickness: 20
        }]

          },

          options:{
          scales:
          {
            y:{beginAtZero:true}
          },
          responsive:true,
          plugins:
          {
            tooltip:
            {
              callback:
              {
                label:(context)=>context.rawMeals.food
              }
            }
          }

          }
        });
        
      },
       addMeal() 
      {
        const food = this.newFood.toLowerCase().trim(); 
        console.log(food);
        const fgrams = parseFloat(this.newGrams);
        const foodFound = this.foodDatabase[food];

        if (!foodFound) {
          alert("No food found");
          return;
        }

        if (isNaN(fgrams) || fgrams <= 0) {
          alert("Enter valid grams");
          return;
        }

        const factor = fgrams / 100;

        this.meals.push({
          type: this.mealType || "Lunch",
          grams: fgrams,
          food:this.newFood.charAt(0).toUpperCase() + this.newFood.slice(1),
          fat: +(foodFound.fat * factor).toFixed(1),
          carbs: +(foodFound.carbs * factor).toFixed(1),
          protein: +(foodFound.protein * factor).toFixed(1),
          calories: +(foodFound.calories * factor).toFixed(1)
        });
     localStorage.setItem("meals",JSON.stringify(this.meals));
     fetch("http://127.0.0.1:8000/app/logFood/",
     {
       method :"POST",
       credentials : "include",
       headers:
       {
        "Content-Type" : "application/json",

       },
       body: JSON.stringify(
       {
        food_id: foodFound.id,
    grams: fgrams,
    meal_type: this.mealType || "Lunch"
       })

     })
     .then(res=>res.json())
     .then(data=>
      { if(!data.success)
       console.error("Failed : ",data.error);
     })
     .catch(err=>
     {
      console.error("Failed to fetch",err);
     })
        this.newGrams = "";
        this.newFood = "";
        this.updateChart();
      },
    
    },
      mounted()
    { if(this.meals.length)
      this.updateChart();
  
 fetch("http://127.0.0.1:8000/app/getFoods/", {
  credentials: "include"
}).then(res=>res.json())
    .then(data=>
    {
      console.log(data)
      data.foods.forEach(item =>
      {
      this.foodDatabase[item.name.toLowerCase()]={
        id: item.id,
        calories:item.calories,
        protein:item.protein,
        fat: item.fat,
        carbs: item.carbs
      };
      });
    });
  }


  }).mount('#app');


    
//     fetch('http://localhost/ProgrammingStuff/ProjectXDashboard/app-capacitor/api/check.php', {
//   method: 'POST',
// })
// .then(response => response.json())
// .then(data => {
//   console.log(data);
// });
  </script>
</body>
</html>
